extends Node2D

# Set this constant before game start
const in_edit_mode: bool = false
@export var current_level_name = "Cooking"

# Time it takes for falling key to reach critical spot
var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"Cooking" = {
	"fk_times": "[[2.7488399147,   3.3034659027,   3.5274568199,   3.7941008209,  
	  4.3274112343,   4.8500419258,   5.3193612694,   5.8313341736,  
	  6.0233297943,   6.279316008,   6.81260401,   7.3779106735,  
	  7.7832394241,   8.017887175,   8.2311983704,   8.7645092606,  
	  9.2658243774,   9.8204498886,  10.0231028198,  10.2470942139,  
	 10.7804041504,  11.2817192673,  11.7723541855,  11.9963455795,  
	 12.1989985107,  12.4443045258,  12.6682959198,  13.20160681,  
	 13.7455750107,  13.9802227615,  14.2148943542,  14.4282045959,  
	 14.7802000641,  15.3028307556,  15.7934656738,  16.2947817444,  
	 16.8174105286,  17.29738909,  17.8200197815,  18.2786818146,  
	 18.7799730896,  18.9933062195,  19.3132849335,  19.5265951752,  
	 19.8145990967,  20.326571524,  20.774531424,  21.222514212,  
	 21.7984762787,  22.0224676727,  22.2464590668,  22.7584314941,  
	 23.2704039215,  23.8250532745,  24.3583403229,  24.699656546,  
	 24.8809939026,  25.3182955383,  25.7982721924,  26.2995882629,  
	 26.8008814453,  27.0142145752,  27.3021956085,  27.5155058502,  
	 27.8675013184,  28.0701552032,  28.2728090881,  28.4967985748,  
	 28.8274336456,  29.2540789246,  29.4780684113,  29.8193846344,  
	 30.0220366119,  30.246028006,  30.8006754517,  31.2486582397,  
	 31.7499514221,  31.963284552,  32.2726030945,  32.7738962769,  
	 33.2965479492,  33.5311976074,  33.8511744141,  34.2564821838,  
	 34.7791338562,  35.2270937561,  35.7817431091,  35.9950533508,  
	 36.2297258972,  36.7310152649,  37.2429895996,  37.7443056702,  
	 37.9682970642,  38.2242823242,  38.7255755066,  39.2695665955,  
	 39.7815371155,  39.9948473572,  40.2294970154,  40.7414713501,  
	 41.2534418701,  41.7227640747,  42.2773905396,  42.8107004761,  
	 43.3120127319,  43.8666391968,  44.4212885498,  45.0079088806,  
	 45.5945559143,  46.1811991333,  46.7678194641,  46.9704714417,  
	 47.1624689697,  47.3437815308,  47.5784540771,  47.7917643188,  
	 48.101086676,  48.6450548767,  49.2210169434,  49.7009935974,  
	 50.2236452698,  50.7676172852,  51.2795878052,  51.8235560059,  
	 52.3248720764,  52.8155069946,  53.2954836487,  53.7967768311,  
	 54.2447596191,  54.746071875,  55.2367067932,  55.7486811279,  
	 56.2926493286,  56.7939653992,  57.2952585815,  57.8179102539,  
	 58.3298845886,  58.7991800903,],  
	 [], [], []]
	",
	"music": load("res://music/Fastfall (Dustforce OST) - 04 Fifty FPS Forest - Lifeformed.wav")
	},

	"Jogging" = {
		"fk_times": "[[2.9941459297,   3.5594521164,   4.476730883,   5.3940325378,  
  7.1752567886,   8.487184584,   8.7111759781,   9.4898148178,  
 10.3110848068,  11.2923775314,  12.0923319458,  12.6043043732,  
 13.1269350647,  13.8309031128,  15.2601557373,  16.5934210419,  
 18.353329718,  18.8866396545,  19.3559370636,  19.5586138367,  
 20.6145544647,  20.8065271973,  21.009202063,  21.1905184387,  
 21.8411532043,  22.0331488251,  23.1317415833,  23.5903826355,  
 24.5716734528,  25.5102911591,  27.0462103485,  27.5048494934,  
 28.262150824,  28.6674566864,  30.0113802551,  30.5553484558,  
 32.2405863403,  32.7525568604,  33.8085222839,  34.7897921204,  
 35.7604036926,  38.7895899414,  39.2588854431,  39.8241930603,  
 40.2828302979,  41.2641230225,  41.7334185242,  42.8320360779,  
 43.6853266357,  44.7732630371,  45.4878893494,  46.1811991333,  
 47.0877962708,  47.6317873596,  48.2184076904,  48.8903818726,  
 49.6903353333,  51.3115854858], [], [3.3567991852,   4.0287719368,   4.786050856,   4.9887037872,  
  5.1913567184,   5.9699965118,   6.9406090378,   7.4739189743,  
  8.0392256378,   9.7777968048,  10.8123999237,  11.5910168289,  
 13.5322638153,  14.2362099289,  14.8335104584,  15.0255060791,  
 16.4121046661,  16.8174105286,  17.8093615173,  20.0599051117,  
 21.3931704163,  22.3744631409,  23.3877287506,  24.0383635162,  
 24.8383188843,  25.8836012482,  26.7795420288,  27.2808580994,  
 27.9741469025,  28.4541235565,  28.9341002106,  29.2754164337,  
 29.6167307495,  30.3100424408,  30.8540087341,  31.0566645264,  
 31.3126497864,  32.5605860352,  33.3605394958,  34.3418093323,  
 35.3124209045,  36.2723780273,  36.8056879639,  37.3603144287,  
 37.8402910828,  38.3416071533,  40.8054857849,  41.5521059631,  
 41.9894075989,  42.4587259888,  43.3546686768,  44.2719469666,  
 45.2852335571,  45.7758684753,  46.7038279175,  47.3544626831,  
 47.9090891479,  48.687729895,  49.4876833557,  50.2556429504,  
 50.788952887,  51.0236025452,  51.7915621399,  52.2821970581,  
 52.8794985413], []]",
		"music": load("res://music/Main Theme (Mii Channel) - Super Smash Bros. Brawl.wav")
	},
	
	"Folding" = {
		"fk_times": "[[3.2821279167,   5.5753479599,   6.1619916557,   6.7059603333,
  9.2764816879,   13.0949392914,   16.3587713837,   16.8280916809,
  17.0307455658,   17.2547350525,   19.6439428925,   21.4038286804,
  26.1289301514,   26.5982275604,   27.099543631,   30.4593611359,
  32.7738962769,   35.9310618042,   36.4003801941,   36.923012793,
  39.5468683838,   41.4560976624,   44.3999491333,   46.7571612,
  47.770428717,   49.5943499207,   51.4289065002,   53.7967768311], 
	[3.7301097511,   5.1273661255,   7.143261969,   7.6552343964,
  8.881833136,   10.2044411301,   10.7377291321,   12.6043043732,
  13.4042597412,   14.9295206665,   15.452151358,   15.9748030304,
  18.3106775879,   20.1025820374,   20.5612211823,   21.8944864868,
  23.8463678955,   24.6570025085,   25.2329664825,   27.579520285,
  29.5100641846,   30.000721991,   30.9073420166,   33.2325373291,
  33.957840979,   34.4378176331,   34.9497919678,   35.440426886,
  37.3496561646,   39.248227179,   39.8028536438,   41.1574564575,
  41.690766394,   43.4719935059,   43.9519701599,   44.8585901855,
  46.2771845459,   47.0024691223,   48.207753241,   49.1783648132,
  50.0529909729,   50.7782717346,   51.9302225708,   53.3061419128],
	 [],
	 [4.1034203171,   4.6473885178,   8.0605402588,   8.4231939911,
  9.6071396469,   11.2070484756,   11.7296791672,   12.1776610016,
  13.8948946594,   14.5028753876,   17.8093615173,   18.7799730896,
  19.2812891602,   20.8065271973,   22.385121405,   22.8757563232,
  23.3450766205,   24.3796797394,   25.6809492706,   28.1021509766,
  28.6034651398,   29.094100058,   31.3233080505,   31.7712870239,
  31.9739428162,   32.2939196228,   37.8402910828,   38.3416071533,
  38.8002443909,   40.3041697144,   40.7414713501,   42.0747347473,
  42.5973902344,   43.0560274719,   45.0719233154,   45.4772310852,
  45.8718767761,   47.2264605164,   48.6450548767,   50.4796343445,
  52.3995218872,   52.8794985413]]",
		"music": load("res://music/Toy Tracks - Kirbys Epic Yarn.wav")
	},
}

# Called when the node enters the scene tree for the first time.
func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			#change here, update the level name
			if current_level_name == "Cooking":
				var button_name: String = ""
				match counter:
					0:
						button_name = "button_Q"
					1:
						button_name = "button_W"
					2:
						button_name = "button_E"
					3:
						button_name = "button_R"
				
				for delay in key:
					SpawnFallingKey(button_name, delay)
				
				counter += 1
			
			elif current_level_name == "Folding":
				var button_name: String = ""
				match counter:
					0:
						button_name = "button_Q"
					1:
						button_name = "button_W"
					2:
						button_name = "button_R"
					3:
						button_name = "button_E"
				
				for delay in key:
					SpawnFallingKey(button_name, delay)
				
				counter += 1
			
			elif current_level_name == "Jogging":
				var button_name: String = ""
				match counter:
					0:
						button_name = "left_click"
					2:
						button_name = "right_click"
				
				for delay in key:
					SpawnFallingKey(button_name, delay)
				
				counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
